# sudoAMM v2 Infrastructure Blueprint
# Deploy with: Connect repo to Render, or `render blueprint apply`
#
# Services:
#   - PostgreSQL database (managed, with connection pooling)
#   - Indexer (background worker - processes Starknet events)
#   - API server (web service - REST endpoints) [optional, uncomment when ready]
#
# Build Filters:
#   Each service only rebuilds when its specific files change.
#   Changes to render.yaml always trigger a sync regardless of filters.

databases:
  - name: sudoswap-db
    plan: basic-256mb # ~$7/mo - upgrade to basic-1gb ($20) or standard-1gb ($50) for production
    databaseName: sudoswap
    postgresMajorVersion: 16
    ipAllowList: [] # Allow all IPs (Render services connect internally)
    # Uncomment for production:
    # plan: standard-1gb
    # readReplicas:
    #   - name: sudoswap-db-replica

services:
  # ===========================================
  # Indexer (Background Worker)
  # ===========================================
  - type: worker
    name: sudoswap-indexer
    runtime: docker
    plan: starter # $7/mo - upgrade to standard ($25) for more CPU/memory
    region: oregon # or frankfurt for EU
    dockerfilePath: ./Dockerfile
    dockerContext: .
    # Only rebuild when indexer files change
    buildFilter:
      paths:
        - src/**
        - indexers/**
        - scripts/**
        - migrations/**
        - Dockerfile
        - package.json
        - apibara.config.ts
        - drizzle.config.ts
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: sudoswap-db
          property: connectionString
      # Apibara DNA Stream URL - use your private stream or public endpoint
      - key: APIBARA_STREAM_URL
        sync: false # Set manually in Render dashboard (e.g., https://your-private-stream.apibara.com)
      # DNA_TOKEN is optional - only needed for public Apibara streams
      # For private streams, leave this empty and just set APIBARA_STREAM_URL
      - key: DNA_TOKEN
        sync: false # Set manually if using public Apibara (optional for private streams)
      # Factory contract address - override when deploying updated contracts
      - key: FACTORY_ADDRESS
        value: "0x06ddd1b3ad87f0f09662b9156d5d5123bf8f9303a58524505f90b5822b742a6a"
        sync: false # Can be overridden in Render dashboard
      # Starting block - set to block before factory deployment
      - key: STARTING_BLOCK
        value: "850000"
        sync: false # Can be overridden in Render dashboard

  # ===========================================
  # API Server (REST endpoints)
  # Uncomment when API is implemented
  # ===========================================
  # - type: web
  #   name: sudoswap-api
  #   runtime: docker
  #   plan: starter # $7/mo - upgrade for production
  #   region: oregon
  #   dockerfilePath: ./api/Dockerfile
  #   dockerContext: ./api
  #   healthCheckPath: /health
  #   buildFilter:
  #     paths:
  #       - api/**
  #       - src/lib/schema.ts
  #   envVars:
  #     - key: NODE_ENV
  #       value: production
  #     - key: PORT
  #       value: "3001"
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: sudoswap-db
  #         property: connectionString
  #     - key: CORS_ORIGIN
  #       sync: false # Set manually in dashboard (e.g., https://sudoswap.xyz)
  #   # Autoscaling (requires Pro plan - $25/mo per instance)
  #   # plan: pro
  #   # autoscaling:
  #   #   minInstances: 1
  #   #   maxInstances: 5
  #   #   targetCPUPercent: 70
  #   #   targetMemoryPercent: 80

  # ===========================================
  # Redis (for caching/WebSocket scaling)
  # Uncomment when needed
  # ===========================================
  # - type: redis
  #   name: sudoswap-redis
  #   plan: starter # $10/mo
  #   region: oregon
  #   ipAllowList: []

# ===========================================
# Environment Variable Groups
# Shared secrets across services
# ===========================================
envVarGroups:
  - name: sudoswap-secrets
    envVars:
      # Private stream URL (required)
      - key: APIBARA_STREAM_URL
        sync: false # Must be set manually in Render dashboard
      # DNA token (optional - only for public Apibara streams)
      - key: DNA_TOKEN
        sync: false # Optional - leave empty for private streams

# ===========================================
# Preview Environments (PR deployments)
# Uncomment for staging/PR preview deployments
# ===========================================
# previewsEnabled: true
# previewsExpireAfterDays: 7
